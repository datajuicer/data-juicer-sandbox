
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developer Guide &#8212; Data Juicer Sandbox</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=b26f9bd0" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/DeveloperGuide';</script>
    <script src="../_static/sidebar.js?v=9ff78125"></script>
    <link rel="icon" href="../_static/icon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Q&amp;A" href="QA.html" />
    <link rel="prev" title="User Guide" href="UserGuide.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search docs..."
         aria-label="Search docs..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/icon.png" class="logo__image only-light" alt=""/>
    <img src="../_static/icon.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Data Juicer Sandbox</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer/en/main/">
    Core
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/datajuicer/data-juicer-sandbox" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown">
    <div class="navbar-dropdown-trigger">
      <span class="dropdown-label">
        üåê en
      </span>
      <i class="fa-solid fa-chevron-down dropdown-icon"></i>
    </div>
    <div class="navbar-dropdown-panel">
      <div class="dropdown-content">
        
        <a href="../../../en/main/docs/DeveloperGuide.html"
           class="dropdown-item active">
          English
        </a>
        
        <a href="../../../zh_CN/main/docs/DeveloperGuide_ZH.html"
           class="dropdown-item ">
          ÁÆÄ‰Ωì‰∏≠Êñá
        </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown">
    <div class="navbar-dropdown-trigger">
      <span class="dropdown-label">
        üì¶ main
      </span>
      <i class="fa-solid fa-chevron-down dropdown-icon"></i>
    </div>
    <div class="navbar-dropdown-panel">
      <div class="dropdown-content version-list">
        
        <a href="../../main/docs/DeveloperGuide.html"
           class="dropdown-item active">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer/en/main/">
    Core
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/datajuicer/data-juicer-sandbox" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown">
    <div class="navbar-dropdown-trigger">
      <span class="dropdown-label">
        üåê en
      </span>
      <i class="fa-solid fa-chevron-down dropdown-icon"></i>
    </div>
    <div class="navbar-dropdown-panel">
      <div class="dropdown-content">
        
        <a href="../../../en/main/docs/DeveloperGuide.html"
           class="dropdown-item active">
          English
        </a>
        
        <a href="../../../zh_CN/main/docs/DeveloperGuide_ZH.html"
           class="dropdown-item ">
          ÁÆÄ‰Ωì‰∏≠Êñá
        </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown">
    <div class="navbar-dropdown-trigger">
      <span class="dropdown-label">
        üì¶ main
      </span>
      <i class="fa-solid fa-chevron-down dropdown-icon"></i>
    </div>
    <div class="navbar-dropdown-panel">
      <div class="dropdown-content version-list">
        
        <a href="../../main/docs/DeveloperGuide.html"
           class="dropdown-item active">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="UserGuide.html">User Guide</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="QA.html">Q&amp;A</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Third-party</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../thirdparty/mm_eval/inception_metrics/README.html">Metrics for video generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thirdparty/mm_eval/vbench_metrics/README.html">VBench metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thirdparty/models/README.html">Third-party Model Library</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../docs_index.html" class="nav-link">DOCS</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Developer Guide</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="developer-guide">
<h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Link to this heading">#</a></h1>
<p>As mentioned in the previous section, developers can develop customized configurable components and add them to the corresponding factory classes, then route to appropriate instantiation methods using the <code class="docutils literal notranslate"><span class="pre">type</span></code> parameter. Once the components are implemented, developers can encapsulate them as hooks and register the hooks into the job list. After the job list is orchestrated in the pipeline, when the sandbox pipeline is executed, each job in the job list will be executed in sequence at each step. Each of these parts - components, component factory, hooks, job lists, and the registration and execution orchestration of the pipeline - can be customized by the developer. The relationship among these parts is illustrated in the diagram below.
<img alt="sandbox-pipeline" src="https://img.alicdn.com/imgextra/i3/O1CN01ERmGre1uz3luKOn4n_!!6000000006107-2-tps-4655-1918.png" /></p>
<section id="the-internal-implementation-of-components">
<h2>The Internal Implementation of Components<a class="headerlink" href="#the-internal-implementation-of-components" title="Link to this heading">#</a></h2>
<p>Currently, components are mainly divided into three major categories:</p>
<ul class="simple">
<li><p><strong>Executor</strong>: Since the data executor is already handled by the Data-Juicer‚Äôs Executor, the executor here specifically refers to the model executor, including model training, inference, evaluation, etc. The code is located <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/model_executors.py">here</a>.</p></li>
<li><p><strong>Evaluator</strong>: Used for evaluating the quality and performance of datasets or models. The code is located <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/evaluators.py">here</a>.</p></li>
<li><p><strong>DataPoolManipulator</strong>: Used for manipulating the data pool, such as construction, combination, sampling, etc. The code is located <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/data_pool_manipulators.py">here</a>.</p></li>
</ul>
<section id="executor">
<h3>Executor<a class="headerlink" href="#executor" title="Link to this heading">#</a></h3>
<p>The core function of the model executor is to train, infer, or evaluate the model specified in the configuration file with the specified dataset. The model executor needs to inherit from <code class="docutils literal notranslate"><span class="pre">BaseModelExecutor</span></code> and implement several core methods:</p>
<ul class="simple">
<li><p>The specific behavior of the model executor (training, inference, evaluation, etc.) needs to be defined in the <code class="docutils literal notranslate"><span class="pre">_run</span></code> method.</p></li>
<li><p>The model executor does not return any value. Key metrics that need to be monitored during execution are usually parsed from the logs produced by the model executor (such as loss, evaluation results, etc.). The parsing and monitoring process needs to be defined by the <code class="docutils literal notranslate"><span class="pre">_watch_run</span></code> method.</p></li>
<li><p>Model executor requires input from a dataset, so the <code class="docutils literal notranslate"><span class="pre">data_connector</span></code> method needs to be implemented to convert the dataset from the sandbox‚Äôs format to the format required by the model framework or library.</p></li>
</ul>
<p>It is important to note that, to monitor the change of training metrics (e.g., loss) promptly during the model training process, logs generated during training need to be monitored. Therefore, both the <code class="docutils literal notranslate"><span class="pre">_run</span></code> method for executing model training and the <code class="docutils literal notranslate"><span class="pre">watch_run</span></code> method for monitoring logs need to be asynchronous methods, indicated by the <code class="docutils literal notranslate"><span class="pre">async</span></code> keyword. In the <code class="docutils literal notranslate"><span class="pre">run</span></code> method, we redirect the standard output stream (stdout) and standard error stream (stderr) to a designated log file before the training starts. Then, we create two asynchronous tasks to execute the aforementioned two methods, each performing the following tasks:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_run</span></code> method: After loading the dataset, it starts model training based on the model training configuration. Upon completion of training, it outputs a predefined task completion identifier to the standard output stream, which has been redirected to the designated log file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">watch_run</span></code> method: It monitors the designated log file, reads it line by line, and calls the <code class="docutils literal notranslate"><span class="pre">_watch_run</span></code> method. The called method is customized based on the model training framework and used to parse the latest log content line, extract key metrics, and monitor them until the predefined task completion identifier is read.</p></li>
</ul>
</section>
<section id="evaluator">
<h3>Evaluator<a class="headerlink" href="#evaluator" title="Link to this heading">#</a></h3>
<p>The core function of the evaluator is to evaluate the quality and performance of the target using some specific methods and return the evaluation result, usually a numerical value. The evaluator needs to inherit from the base class <code class="docutils literal notranslate"><span class="pre">BaseEvaluator</span></code> and implement the <code class="docutils literal notranslate"><span class="pre">run</span></code> method. The <code class="docutils literal notranslate"><span class="pre">run</span></code> method typically takes two required parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">eval_type</span></code>: The type of evaluation, used for internal evaluation type routine within a certain evaluator.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eval_obj</span></code>: The object to be evaluated.</p></li>
</ul>
<p>Users can also extend the usage of these two parameters based on their implementation.</p>
</section>
<section id="datapoolmanipulator">
<h3>DataPoolManipulator<a class="headerlink" href="#datapoolmanipulator" title="Link to this heading">#</a></h3>
<p>The core function of the data pool manipulator is to manipulate the data pool, such as construction, combination, sampling, etc. The data pool manipulator needs to inherit from the base class <code class="docutils literal notranslate"><span class="pre">BaseDataPoolManipulator</span></code> and implement the <code class="docutils literal notranslate"><span class="pre">run</span></code> method. The necessary parameters usually come from the input data pool configs in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method, covering input data pools, export paths, and specific parameters for each type of manipulators.</p>
<p>Users can refer to the doc string of the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of each manipulator for more details <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/data_pool_manipulators.py">here</a>.</p>
</section>
</section>
<section id="pipeline-hook">
<h2>Pipeline Hook<a class="headerlink" href="#pipeline-hook" title="Link to this heading">#</a></h2>
<p>As mentioned at the start of this section, in the pipeline, we need to implement several hooks to connect components with the pipeline execution steps through the job list. Activated hooks will be registered in the pipeline‚Äôs job list and then executed one by one during the pipeline execution at each step. The job lists for the four corresponding steps are as follows:</p>
<ol class="arabic simple">
<li><p><strong>Data/Model Probe</strong>: Probe job list ‚Äì probe_jobs</p></li>
<li><p><strong>Iterative Recipe Refinement based on Probe Results</strong>: Refinement job list ‚Äì refine_recipe_jobs</p></li>
<li><p><strong>Data Processing and Model Training</strong>: Execution job list - execution_jobs</p></li>
<li><p><strong>Data/Model Evaluation</strong>: Evaluation job list - evaluation_jobs</p></li>
</ol>
<p>In general, we only need to implement one type of hook function for a type of component factory. In addition to hooks that depend on components, some hooks depend on the existing functionality and tools of Data-Juicer or other third-party libraries. The correspondence among these hooks, dependent components, tools, and job lists is as follows:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Hook</p></th>
<th class="head"><p>Function</p></th>
<th class="head"><p>Dependent Component Factory</p></th>
<th class="head"><p>Dependent Tool or Library</p></th>
<th class="head"><p>Registered Job List</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ProbeViaAnalyzerHook</span></code></p></td>
<td><p>Analyze and probe the quality and diversity distribution of the dataset</p></td>
<td><p>DataAnalyzerFactory</p></td>
<td><p>Data-Juicer Analyzer</p></td>
<td><p>- probe_jobs<br />- evaluation_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ProbeViaModelInferHook</span></code></p></td>
<td><p>Analyze and understand the impact of the dataset on the model, explore and probe ‚Äúdifficult‚Äù and ‚Äúdirty‚Äù data</p></td>
<td><p>DataExecutorFactory <br />ModelInferEvaluatorFactory</p></td>
<td><p>Data-Juicer Executor</p></td>
<td><p>- probe_jobs<br />- evaluation_jobs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GeneralProbeHook</span></code></p></td>
<td><p>General hook for probing the dataset, including ranking the datasets and so on</p></td>
<td><p>GeneralProbeFactory</p></td>
<td><p>-</p></td>
<td><p>- probe_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RefineRecipeViaKSigmaHook</span></code></p></td>
<td><p>Refine data recipe hyperparameters using the k-sigma method based on the probe results of the dataset</p></td>
<td><p>-</p></td>
<td><p>k-sigma recipe refinement tool of Data-Juicer Hyperparameter Optimization (HPO) toolkit</p></td>
<td><p>- refine_recipe_jobs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RefineRecipeViaModelFeedbackHook</span></code></p></td>
<td><p>Refine data recipe hyperparameters using model probe and feedback results</p></td>
<td><p>TODO</p></td>
<td><p>-</p></td>
<td><p>- refine_recipe_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ProcessDataHook</span></code></p></td>
<td><p>Process and clean the dataset based on the current data recipe</p></td>
<td><p>DataExecutorFactory</p></td>
<td><p>Data-Juicer Executor</p></td>
<td><p>- execution_jobs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DataPoolManipulationHook</span></code></p></td>
<td><p>Data pool manipulation,  including construction, combination, sampling, etc.</p></td>
<td><p>DataPoolManipulatorFactory</p></td>
<td><p>-</p></td>
<td><p>- execution_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">GeneralDataExecutorHook</span></code></p></td>
<td><p>General data processing for dataset, including format conversion, etc.</p></td>
<td><p>GeneralDataExecutorFactory</p></td>
<td><p>-</p></td>
<td><p>- execution_jobs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">TrainModelHook</span></code></p></td>
<td><p>Train a model based on the current dataset</p></td>
<td><p>ModelTrainExecutorFactory</p></td>
<td><p><a class="reference external" href="https://github.com/aigc-apps/EasyAnimate">EasyAnimate</a> <br/> <a class="reference external" href="https://internvl.readthedocs.io/en/latest/index.html">InternVL</a></p></td>
<td><p>- execution_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">InferModelHook</span></code></p></td>
<td><p>The model generates output based on the given input</p></td>
<td><p>ModelInferExecutorFactory</p></td>
<td><p><a class="reference external" href="https://github.com/aigc-apps/EasyAnimate">EasyAnimate</a></p></td>
<td><p>- execution_jobs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">EvaluateDataHook</span></code></p></td>
<td><p>Evaluate the dataset in terms of data quality and other dimensions</p></td>
<td><p>DataEvaluatorFactory</p></td>
<td><p><a class="reference internal" href="#../tools/mm_eval/inception_metrics/README.md"><span class="xref myst">inception metrics</span></a> for images and videos, such as FID and FVD <br /> <a class="reference internal" href="#../tools/mm_eval/vbench_metrics/README.md"><span class="xref myst">VBench</span></a></p></td>
<td><p>- evaluation_jobs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">EvaluateModelHook</span></code></p></td>
<td><p>Evaluate the trained model</p></td>
<td><p>ModelEvaluatorFactory</p></td>
<td><p><a class="reference external" href="https://internvl.readthedocs.io/en/latest/tutorials/coco_caption_finetune.html#evaluating-the-fine-tuned-model">InternVL COCO Caption</a></p></td>
<td><p>- evaluation_jobs</p></td>
</tr>
</tbody>
</table>
</div>
<p>It is worth noting that a hook can be registered in multiple job lists, as this hook can play different roles in different steps of the pipeline. For example, we can analyze and probe both the pre-processed and post-processed datasets to compare the changes in quality, diversity, and other dimensions before and after data processing.</p>
</section>
<section id="customized-sandbox-pipeline">
<h2>Customized Sandbox Pipeline<a class="headerlink" href="#customized-sandbox-pipeline" title="Link to this heading">#</a></h2>
<p>Users can directly modify the job configuration list in the parameter configuration file to achieve task modification and orchestration.</p>
</section>
<section id="watcher">
<h2>Watcher<a class="headerlink" href="#watcher" title="Link to this heading">#</a></h2>
<p>In the above sections, the concept of ‚Äúmonitoring‚Äù is repeatedly mentioned. The pipeline will monitor several metrics produced in each step, and these monitoring processes are implemented by <code class="docutils literal notranslate"><span class="pre">SandboxWatcher</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SandboxWatcher</span></code> is based on wandb library and mainly includes four methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">setup_sweep</span></code>: This method is called in the multi-trial HPO mode, which is supported by the sweep module in wandb library. Therefore, the additional <code class="docutils literal notranslate"><span class="pre">hpo_config</span></code> configuration for sweep initialization is required to be passed into the sandbox configuration file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">watch_cfgs</span></code>: This method monitors and updates the sandbox experiments and configuration files of various components.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">watch</span></code>: This method monitors a specific metric or experiment result and records it in the wandb log.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">query</span></code>: This method queries a specific metric or experiment result from the wandb log.</p></li>
</ul>
</section>
<section id="details-of-context-infos">
<h2>Details of Context Infos<a class="headerlink" href="#details-of-context-infos" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">context_infos</span></code> consists of two levels:</p>
<ul class="simple">
<li><p>pipeline level: it‚Äôs the 1st level of <code class="docutils literal notranslate"><span class="pre">context_infos</span></code>, which is a dict with keys are the pipeline names and values are a list of context information of each job in this pipeline.</p></li>
<li><p>job level: it‚Äôs the 2nd level of <code class="docutils literal notranslate"><span class="pre">context_infos</span></code>, which is a list of dicts, each dict represents the context information of a specific job, with <code class="docutils literal notranslate"><span class="pre">meta_name</span></code> to identify the job and other key-value pairs with keys are the name of the outputs of this job and values are the output values.</p></li>
</ul>
<p>Here is an example of <code class="docutils literal notranslate"><span class="pre">context_infos</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;pipeline_0&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;meta_name&#39;</span><span class="p">:</span> <span class="s1">&#39;name1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res1_key&#39;</span><span class="p">:</span> <span class="s1">&#39;res1_value&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res2_key&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">res2_value</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s1">&#39;meta_name&#39;</span><span class="p">:</span> <span class="s1">&#39;name2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res3_key&#39;</span><span class="p">:</span> <span class="s1">&#39;res3_value&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s1">&#39;pipeline_1&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;meta_name&#39;</span><span class="p">:</span> <span class="s1">&#39;name3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res4_key&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">res4_value</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">],</span>
    <span class="s1">&#39;pipeline_2&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;meta_name&#39;</span><span class="p">:</span> <span class="s1">&#39;name4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res5_key&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;res5_1_value&#39;</span><span class="p">,</span> <span class="s1">&#39;res5_2_value&#39;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="environment-manager">
<h2>Environment Manager<a class="headerlink" href="#environment-manager" title="Link to this heading">#</a></h2>
<p>Sandbox supports different kinds of third-party libraries for training, evaluation and so on. If we put all of them into
one environment, version conflicts on some important and complex dependencies will occur. Therefore, we provide an
easy-to-use environment manager to manage different environments for different third-party libraries, allow users to run
commands in isolated environments independently.</p>
<p>The basic class of environment is <code class="docutils literal notranslate"><span class="pre">Env</span></code> <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/env_manager.py">here</a> implemented as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Env</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
  
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;This method must be implemented in subclass.&#39;</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the availability of the environment manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;This method must be implemented in subclass.&#39;</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if an environment exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;This method must be implemented in subclass.&#39;</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">install_py_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install Python dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;This method must be implemented in subclass.&#39;</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a command in this environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;This method must be implemented in subclass.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It consists of five main abstract methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">create</span></code>: create an environment if it does not exist.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">check_availability</span></code>: check the availability of the environment manager (e.g., <code class="docutils literal notranslate"><span class="pre">conda</span></code>, <code class="docutils literal notranslate"><span class="pre">venv</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exists</span></code>: check if an environment exists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">install_py_deps</span></code>: install Python dependencies. Usually support three ways: a ‚Äúrequirements.txt‚Äù file path, a dependency list, or a directory path to a library code base.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_cmd</span></code>: run a command in this environment.</p></li>
</ul>
<p>Now we provide two concrete implementations of <code class="docutils literal notranslate"><span class="pre">Env</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CondaEnv</span></code>: use <code class="docutils literal notranslate"><span class="pre">conda</span></code> or <code class="docutils literal notranslate"><span class="pre">mamba</span></code> to manage environments.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VirtualEnv</span></code>: use <code class="docutils literal notranslate"><span class="pre">venv</span></code>, <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code>, or <code class="docutils literal notranslate"><span class="pre">uv</span> <span class="pre">venv</span></code> to manage environments.</p></li>
</ul>
<p>When initializing the environment manager, we can specify the environment manager to use by setting the <code class="docutils literal notranslate"><span class="pre">env_manager</span></code> parameter in the configuration file and the name of the environment by setting the <code class="docutils literal notranslate"><span class="pre">env_name</span></code> parameter. An example of the basic usage is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer_sandbox.env_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ENV_ROUTER</span>

<span class="n">env_manager</span> <span class="o">=</span> <span class="s1">&#39;conda&#39;</span>
<span class="n">env_name</span> <span class="o">=</span> <span class="s1">&#39;new_conda_env&#39;</span>

<span class="c1"># create an environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">ENV_ROUTER</span><span class="p">[</span><span class="n">env_manager</span><span class="p">](</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">datajuicer</span><span class="o">/</span><span class="n">data</span><span class="o">-</span><span class="n">juicer</span><span class="o">-</span><span class="n">sandbox</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span>
    <span class="n">env_name</span><span class="o">=</span><span class="n">env_name</span><span class="p">,</span>
    <span class="n">env_manager</span><span class="o">=</span><span class="n">env_manager</span><span class="p">)</span>
<span class="c1"># check the availability</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">check_availability</span><span class="p">():</span>
    <span class="c1"># this env manager is not available</span>
    <span class="n">exit</span><span class="p">()</span>
<span class="c1"># create a new env. If it&#39;s already existing, use the existing one</span>
<span class="n">env</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

<span class="c1"># install extra dependencies</span>
<span class="c1"># use a &quot;requirements.txt&quot; file</span>
<span class="n">env</span><span class="o">.</span><span class="n">install_py_deps</span><span class="p">(</span><span class="s2">&quot;/path/to/requirements.txt&quot;</span><span class="p">)</span>
<span class="c1"># use a dependency list</span>
<span class="n">env</span><span class="o">.</span><span class="n">install_py_deps</span><span class="p">([</span><span class="s2">&quot;torch&quot;</span><span class="p">,</span> <span class="s2">&quot;torchvision&quot;</span><span class="p">])</span>
<span class="c1"># use a directory path to a library code base, e.g., InternVL</span>
<span class="n">env</span><span class="o">.</span><span class="n">install_py_deps</span><span class="p">(</span><span class="s2">&quot;/path/to/a/third-party/library&quot;</span><span class="p">)</span>

<span class="c1"># run a command in this environment</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;python train.py&quot;</span>
<span class="n">env</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</div>
<p>A complete example of using the environment manager in a hook is available in the <code class="docutils literal notranslate"><span class="pre">InternVLCOCOCaptionEvaluator</span></code> class <a class="reference external" href="https://github.com/datajuicer/data-juicer-sandbox/blob/main/data_juicer_sandbox/specific_hooks/intervl_coco_captioning/model_hooks.py">here</a>.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="UserGuide.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">User Guide</p>
      </div>
    </a>
    <a class="right-next"
       href="QA.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Q&amp;A</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-internal-implementation-of-components">The Internal Implementation of Components</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#executor">Executor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluator">Evaluator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#datapoolmanipulator">DataPoolManipulator</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pipeline-hook">Pipeline Hook</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#customized-sandbox-pipeline">Customized Sandbox Pipeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#watcher">Watcher</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#details-of-context-infos">Details of Context Infos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-manager">Environment Manager</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/docs/DeveloperGuide.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      ¬© Copyright 2024, Data-Juicer Team.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>